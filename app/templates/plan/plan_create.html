{% extends 'layout.html' %}

{% block title %}旅行概要の入力 | もちリスト{% endblock %}

{% block content %}
<div class="plan-create-shell">
  <div class="plan-create-card">
    <div class="page-top">
      <h1>旅行概要を入力してください</h1>
      <span class="required-note">※は必須です</span>
    </div>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% set error_messages = [] %}
      {% if messages %}
        {% for category, message in messages %}
          {% if category in ['error', 'danger'] %}
            {% set error_messages = error_messages + [message] %}
          {% endif %}
        {% endfor %}
      {% endif %}
      {% set has_errors = (error_messages or form.errors) %}
      <section
        class="error-modal {% if has_errors %}is-open{% endif %}"
        data-error-modal
        {% if not has_errors %}hidden{% endif %}
      >
        <div class="error-modal__backdrop" data-error-dismiss></div>
        <div class="error-modal__dialog" role="alertdialog" aria-modal="true" aria-labelledby="plan-error-title">
          <p id="plan-error-title" class="error-modal__title">エラーが発生しました</p>
          <ul class="error-modal__list" data-error-list>
            {% for message in error_messages %}
              <li>{{ message }}</li>
            {% endfor %}
            {% if form.errors %}
              {% for field, errors in form.errors.items() %}
                {% for error in errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              {% endfor %}
            {% endif %}
          </ul>
          <div class="error-modal__actions">
            <button type="button" class="cta-button" data-error-close>閉じる</button>
          </div>
        </div>
      </section>
    {% endwith %}

    <form method="POST" action="{{ url_for('plan.plan_create_form') }}" class="modern-plan-form">
      {{ form.csrf_token }}

      <div class="field-block required">
        <label class="field-label">行きたい場所</label>
        {{ form.destination(class="form-input", placeholder="例: 沖縄, 東京タワー") }}
        {% if form.destination.errors %}
          <ul class="error-messages">
            {% for error in form.destination.errors %}
              <li class="error-text">{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="field-block required departure-block">
        <label class="field-label">出発地点</label>
        <div class="departure-row">
          <div class="origin-row">
            <label class="pill-radio">
              <input type="radio" name="departure_mode" value="current" checked>
              <span class="radio-visual"></span>
              <span>位置情報から取得</span>
            </label>
            <label class="pill-radio">
              <input type="radio" name="departure_mode" value="custom">
              <span class="radio-visual"></span>
              <span>出発場所を指定する</span>
            </label>
          </div>
          <div class="departure-input-wrap">
            {{ form.departure(class="form-input", placeholder="出発地を入力", **{'data-departure-input': ''}) }}
          </div>
        </div>
        {% if form.departure.errors %}
          <ul class="error-messages">
            {% for error in form.departure.errors %}
              <li class="error-text">{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="field-block">
        <label class="field-label">旅行の目的（複数選択可）</label>
        <input type="text" class="form-input purpose-input" data-purpose-input placeholder="観光/合宿 (Enterで追加)">
        <div class="chip-list" data-purpose-list></div>
        {{ form.purposes_raw(style="display:none;", **{'data-purpose-hidden': ''}) }}
        {% if form.purposes_raw.errors %}
          <ul class="error-messages">
            {% for error in form.purposes_raw.errors %}
              <li class="error-text">{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="two-col">
        <div class="field-block required">
          <label class="field-label">日数</label>
          {{ form.days(class="form-input", placeholder="日間", type="number", min="1", max="30") }}
          {% if form.days.errors %}
            <ul class="error-messages">
              {% for error in form.days.errors %}
                <li class="error-text">{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
        <div class="field-block required">
          <label class="field-label">出発日</label>
          {{ form.start_date(class="form-input", placeholder="MM/DD", type="date") }}
          {% if form.start_date.errors %}
            <ul class="error-messages">
              {% for error in form.start_date.errors %}
                <li class="error-text">{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </div>

      <div class="field-block">
        <label class="field-label">旅行に求めること</label>
        <div class="option-grid">
          {% for subfield in form.options %}
          <label class="option-chip">
            {{ subfield }}
            <span class="option-text">{{ subfield.label.text }}</span>
          </label>
          {% endfor %}
        </div>
        {% if form.options.errors %}
          <ul class="error-messages">
            {% for error in form.options.errors %}
              <li class="error-text">{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="form-actions">
        <button type="submit" class="submit-btn">旅行プランを作成する✨</button>
      </div>
    </form>
  </div>
</div>

<!-- ローディングオーバーレイ -->
<div id="loading-overlay" class="loading-overlay" hidden>
  <div class="spinner-container">
    <div class="spinner"></div>
    <p class="loading-text">最高のプランを考えています...<br><span class="sub-text">※最大30秒ほどかかる場合があります☕️</span></p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- 既存のJS処理 ---
  const input = document.querySelector('[data-purpose-input]');
  const list = document.querySelector('[data-purpose-list]');
  const hidden = document.querySelector('[data-purpose-hidden]');
  const departureInput = document.querySelector('[data-departure-input]');
  const departureRadios = document.querySelectorAll('input[name="departure_mode"]');
  const errorModal = document.querySelector('[data-error-modal]');
  const errorList = errorModal?.querySelector('[data-error-list]');

  const openErrorModal = (messages) => {
    if (!errorModal || !errorList) return;
    const items = Array.isArray(messages) ? messages : [messages];
    errorList.innerHTML = '';
    items.filter(Boolean).forEach((message) => {
      const li = document.createElement('li');
      li.textContent = message;
      errorList.appendChild(li);
    });
    errorModal.hidden = false;
    errorModal.classList.add('is-open');
  };

  let values = hidden.value ? hidden.value.split(',').map(s => s.trim()).filter(s => s) : [];

  const render = () => {
    list.innerHTML = '';
    values.forEach((val, idx) => {
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.textContent = val + ' ';
      
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'chip-remove';
      removeBtn.innerHTML = '&times;';
      removeBtn.onclick = () => remove(idx);
      
      chip.appendChild(removeBtn);
      list.appendChild(chip);
    });
    hidden.value = values.join(',');
  };

  const add = () => {
    const val = input.value.trim();
    if (val && !values.includes(val)) {
      values.push(val);
      input.value = '';
      render();
    }
  };

  const remove = (index) => {
    values.splice(index, 1);
    render();
  };

  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      add();
    }
  });
  
  const updateDepartureMode = async (mode, preserveValue = false) => {
    if (!departureInput) return;
    if (mode === 'current') {
      departureInput.value = '現在地を取得中...';
      departureInput.readOnly = true;
      departureInput.classList.add('readonly');
      try {
        const position = await getCurrentPosition();
        const address = await reverseGeocode(position.coords.latitude, position.coords.longitude);
        departureInput.value = address;
      } catch (error) {
        console.error('位置情報の取得に失敗しました:', error);
        departureInput.value = '現在地（取得失敗）';
        openErrorModal(['位置情報の取得に失敗しました。ネットワークや位置情報の設定を確認してください。']);
      }
    } else {
      if (!preserveValue && (departureInput.value === '現在地' || departureInput.value === '現在地を取得中...' || departureInput.value.startsWith('現在地（'))) {
        departureInput.value = '';
      }
      departureInput.readOnly = false;
      departureInput.classList.remove('readonly');
      departureInput.focus();
    }
  };

  const getCurrentPosition = () => {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error('Geolocation is not supported by this browser.'));
        return;
      }
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 300000
      });
    });
  };

  const reverseGeocode = async (lat, lon) => {
    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=ja`);
    if (!response.ok) {
      throw new Error('Reverse geocode failed');
    }
    const data = await response.json();
    if (data && data.display_name) {
      // 住所を簡略化（例: 東京都渋谷区... など）
      const address = data.display_name.split(',')[0] + (data.display_name.split(',')[1] ? ', ' + data.display_name.split(',')[1] : '');
      return address;
    } else {
      throw new Error('住所の取得に失敗しました');
    }
  };

  departureRadios.forEach(radio => {
    radio.addEventListener('change', (e) => updateDepartureMode(e.target.value));
  });

  const initialMode = (() => {
    if (!departureInput) return 'current';
    return departureInput.value && departureInput.value !== '現在地' ? 'custom' : 'current';
  })();
  const initialRadio = document.querySelector(`input[name="departure_mode"][value="${initialMode}"]`);
  if (initialRadio) {
    initialRadio.checked = true;
  }

  updateDepartureMode(initialMode, true);
  render();

  // --- ローディング処理の追加 ---
  const form = document.querySelector('.modern-plan-form');
  const loadingOverlay = document.getElementById('loading-overlay');
  const submitBtn = document.querySelector('.submit-btn');

  if (form && loadingOverlay) {
    form.addEventListener('submit', (e) => {
      if (!navigator.onLine) {
        e.preventDefault();
        openErrorModal(['ネットワークに接続されていません。接続を確認して再度お試しください。']);
        if (submitBtn) submitBtn.disabled = false;
        return;
      }
      // バリデーションチェック（required属性などが満たされているか）
      if (!form.checkValidity()) {
        // バリデーションエラー時はローディングを出さない（ブラウザのデフォルト挙動に任せる）
        return;
      }
      
      // 送信ボタンを無効化して二重送信防止
      if (submitBtn) {
        submitBtn.disabled = true;
      }

      // ローディング画面を表示
      loadingOverlay.hidden = false;
      
      // アニメーション用クラス付与
      setTimeout(() => {
        loadingOverlay.classList.add('active');
      }, 10);
    });

    // ページ遷移して戻ってきた場合（bfcache対策）などに備えて表示をリセット
    window.addEventListener('pageshow', (event) => {
      if (event.persisted) {
        loadingOverlay.hidden = true;
        loadingOverlay.classList.remove('active');
        if (submitBtn) submitBtn.disabled = false;
      }
    });
  }

  if (errorModal) {
    const closeModal = () => {
      errorModal.classList.remove('is-open');
      errorModal.setAttribute('hidden', '');
    };

    const closeBtn = errorModal.querySelector('[data-error-close]');
    const backdrop = errorModal.querySelector('[data-error-dismiss]');

    closeBtn?.addEventListener('click', closeModal);
    backdrop?.addEventListener('click', closeModal);

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && errorModal.classList.contains('is-open')) {
        closeModal();
      }
    });
  }
});
</script>

<style>
/* 既存スタイル */
.plan-create-shell {
  max-width: 1200px;
  margin: 0 auto;
  padding: 36px 28px 78px;
}
.plan-create-card {
  width: 100%;
  max-width: 980px;
  margin: 0 auto;
  background: transparent;
  padding: 0;
  border: none;
  box-shadow: none;
}
.page-top {
  display: flex;
  align-items: baseline;
  gap: 16px;
  margin-bottom: 24px;
}
.page-top h1 {
  font-size: 22px;
  font-weight: 700;
  margin: 0;
}
.required-note {
  color: #d32f2f;
  font-size: 14px;
}
.modern-plan-form {
  display: flex;
  flex-direction: column;
  gap: 20px;
  max-width: 980px;
}
.field-block {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.field-block.required .field-label::before {
  content: '※';
  color: #d32f2f;
  margin-right: 6px;
}
.field-label {
  font-weight: 600;
  font-size: 15px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.form-input {
  width: 100%;
  padding: 12px 14px;
  border: 1.4px solid #3d3d3d;
  border-radius: 14px;
  font-size: 15px;
  transition: border-color 0.15s ease, box-shadow 0.15s ease;
}
.form-input:focus {
  outline: none;
  border-color: #7068f8;
  box-shadow: 0 0 0 3px rgba(112, 104, 248, 0.15);
}
.form-input.readonly {
  background: #fafafa;
  color: #555;
}
.origin-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}
.pill-radio {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  border: 1.4px solid #3d3d3d;
  border-radius: 18px;
  cursor: pointer;
  user-select: none;
  font-size: 14px;
}
.pill-radio input {
  display: none;
}
.departure-row {
  display: grid;
  gap: 10px;
}
.departure-input-wrap {
  width: 100%;
}
@media (min-width: 720px) {
  .departure-row {
    grid-template-columns: minmax(320px, 0.9fr) minmax(420px, 1fr);
    align-items: center;
    gap: 16px;
  }
  .origin-row {
    flex-wrap: nowrap;
  }
}
.radio-visual {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 1.4px solid #3d3d3d;
  display: inline-block;
  position: relative;
}
.pill-radio input:checked + .radio-visual {
  border-color: #7068f8;
  box-shadow: inset 0 0 0 6px #7068f8;
}
.two-col {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 16px;
}
.purpose-input {
  margin-bottom: 4px;
}
.chip-list {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 16px;
  background: #dfe0e6;
  color: #333;
  font-size: 14px;
}
.chip-remove {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 16px;
  line-height: 1;
  color: #333;
}
.option-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
  gap: 10px;
}
.option-chip {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  border: 1.4px solid #3d3d3d;
  border-radius: 14px;
  font-size: 14px;
  cursor: pointer;
  user-select: none;
}
.option-chip input[type="checkbox"] {
  accent-color: #7068f8;
  width: 16px;
  height: 16px;
}
.option-text {
  line-height: 1.3;
}
.form-actions {
  margin-top: 14px;
}
.submit-btn {
  width: 100%;
  padding: 14px;
  border: 1px solid #111;
  border-radius: 16px;
  background: #111;
  color: #fff;
  font-size: 17px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
  transition: transform 0.1s ease, box-shadow 0.15s ease;
}
.submit-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.3);
}
.submit-btn:active {
  transform: translateY(0);
}
.submit-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}
.error-messages {
  list-style: none;
  padding: 0;
  margin: 4px 0 0;
  color: #d32f2f;
  font-size: 13px;
}

.error-modal {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 10000;
}
.error-modal.is-open {
  display: block;
}
.error-modal[hidden] {
  display: none;
}
.error-modal__backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
}
.error-modal__dialog {
  position: relative;
  max-width: 520px;
  margin: 0 auto;
  padding: 24px 26px;
  border-radius: 20px;
  background: #fff;
  top: 50%;
  transform: translateY(-50%);
  box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.error-modal__title {
  margin: 0;
  font-size: 16px;
  font-weight: 700;
  color: #111;
}
.error-modal__list {
  margin: 0;
  padding-left: 1.2rem;
  color: #d32f2f;
  font-size: 14px;
}
.error-modal__actions {
  display: flex;
  justify-content: flex-end;
}

/* --- ローディングオーバーレイのスタイル --- */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.85);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(4px);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
.loading-overlay:not([hidden]) {
  opacity: 1;
  pointer-events: auto;
}
.spinner-container {
  text-align: center;
  color: #333;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.spinner {
  width: 64px;
  height: 64px;
  border: 6px solid #f0f0f0;
  border-top: 6px solid #7068f8;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 24px;
}
.loading-text {
  font-size: 18px;
  font-weight: 700;
  color: #333;
  margin: 0;
  line-height: 1.5;
}
.sub-text {
  font-size: 14px;
  color: #666;
  font-weight: normal;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
{% endblock %}
