{% extends 'layout.html' %}

{% block title %}旅行概要の入力 | もちリスト{% endblock %}

{% block content %}
<div class="plan-create-container">
  <header class="page-header">
    <h1>旅行概要を入力してください <span class="required-note">※は必須です</span></h1>
  </header>

  {# POST送信先を指定。ルート名は plan_routes.py に合わせて適宜調整してください #}
  <form method="POST" action="{{ url_for('plan.plan_create_form') }}" class="plan-form">
    {{ form.csrf_token }}

    {# --- 行先 --- #}
    <div class="form-group">
      {{ form.destination.label(class="form-label") }}
      {{ form.destination(class="form-input", placeholder="例:東京タワー") }}
      
      {% if form.destination.errors %}
        <ul class="error-messages">
          {% for error in form.destination.errors %}
            <li class="error-text">{{ error }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>

    {# --- 出発地 --- #}
    <div class="form-group">
      <label class="form-label">出発地</label>
      <div class="origin-custom-wrapper">
        <label class="radio-card">
            <span class="radio-mark"></span>
            <span class="radio-text">出発場所を指定する</span>
        </label>
        {{ form.departure(class="form-input mt-2", placeholder="例: 東京駅") }}
        
        {% if form.departure.errors %}
          <ul class="error-messages">
            {% for error in form.departure.errors %}
              <li class="error-text">{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    </div>

    {# --- 目的 (JavaScript制御) --- #}
    <div class="form-group">
      {{ form.purposes_raw.label(class="form-label") }}
      <div class="purpose-container">
        {# ユーザー入力用（送信はしないのでname属性なし） #}
        <input type="text" class="form-input purpose-input" data-purpose-input placeholder="観光/合宿 (Enterで追加)">
        
        {# チップ表示エリア #}
        <div class="chip-list" data-purpose-list></div>
        
        {# WTFormsのフィールド (隠しておく・JSがここに値を書き込む) #}
        {{ form.purposes_raw(style="display:none;", **{'data-purpose-hidden': ''}) }}
      </div>
      {% if form.purposes_raw.errors %}
        <ul class="error-messages">
          {% for error in form.purposes_raw.errors %}
            <li class="error-text">{{ error }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>

    {# --- 日数 & 出発日 --- #}
    <div class="form-row">
      <div class="form-group col-half">
        {{ form.days.label(class="form-label") }}
        {{ form.days(class="form-input", placeholder="日間", type="number") }}
        {% if form.days.errors %}
          <ul class="error-messages">
            {% for error in form.days.errors %}
              <li class="error-text">{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="form-group col-half">
        {{ form.start_date.label(class="form-label") }}
        {{ form.start_date(class="form-input", placeholder="YYYY-MM-DD", type="date") }}
        {% if form.start_date.errors %}
          <ul class="error-messages">
            {% for error in form.start_date.errors %}
              <li class="error-text">{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    </div>

    {# --- オプション (Checkbox) --- #}
    <div class="form-group">
      {{ form.options.label(class="form-label") }}
      <div class="needs-grid">
        {# WTFormsのSelectMultipleFieldの選択肢をループして表示 #}
        {% for subfield in form.options %}
        <label class="checkbox-card">
          {{ subfield }}
          <span class="checkbox-text">{{ subfield.label.text }}</span>
        </label>
        {% endfor %}
      </div>
      {% if form.options.errors %}
        <ul class="error-messages">
          {% for error in form.options.errors %}
            <li class="error-text">{{ error }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>

    <div class="form-actions">
      <button type="submit" class="submit-btn">旅行プランを作成する✨</button>
    </div>

  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const input = document.querySelector('[data-purpose-input]');
  const list = document.querySelector('[data-purpose-list]');
  const hidden = document.querySelector('[data-purpose-hidden]');

  // 【修正点】初期値を空にします。
  // 隠しフィールド(WTForms)に値が入っている場合(バリデーションエラーで戻ってきた時など)のみ復元します。
  let values = hidden.value ? hidden.value.split(',').map(s => s.trim()).filter(s => s) : [];

  const render = () => {
    list.innerHTML = '';
    values.forEach((val, idx) => {
      const chip = document.createElement('span');
      chip.className = 'chip';
      // エスケープ処理をしてXSS対策
      chip.textContent = val + ' ';
      
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'chip-remove';
      removeBtn.innerHTML = '&times;';
      removeBtn.onclick = () => remove(idx);
      
      chip.appendChild(removeBtn);
      list.appendChild(chip);
    });
    // 配列をカンマ区切り文字列にして隠しフィールドへセット
    hidden.value = values.join(',');
  };

  const add = () => {
    const val = input.value.trim();
    if (val && !values.includes(val)) {
      values.push(val);
      input.value = '';
      render();
    }
  };

  const remove = (index) => {
    values.splice(index, 1);
    render();
  };

  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault(); // エンターキーでのフォーム送信を防ぐ
      add();
    }
  });
  
  // 初期描画
  render();
});
</script>

<style>
.error-messages {
    list-style: none;
    padding: 0;
    margin: 5px 0 0;
    color: #e74c3c;
    font-size: 0.9em;
}
/* 目的入力欄のチップスタイル（念のため） */
.chip {
    display: inline-flex;
    align-items: center;
    padding: 4px 8px;
    margin: 4px;
    background-color: #e0f2f1;
    color: #00695c;
    border-radius: 16px;
    font-size: 0.9em;
}
.chip-remove {
    background: none;
    border: none;
    color: #00695c;
    margin-left: 4px;
    cursor: pointer;
    font-weight: bold;
    font-size: 1.1em;
    line-height: 1;
}
</style>
{% endblock %}