{% extends 'layout.html' %}

{% block title %}旅行概要の入力 | もちリスト{% endblock %}

{% block content %}
<div class="plan-create-container">
  <header class="page-header">
    <h1>旅行概要を入力してください <span class="required-note">※は必須です</span></h1>
  </header>

  <form method="POST" action="{{ url_for('plan.plan_create') }}" class="plan-form">
    {{ form.csrf_token }}

    <div class="form-group">
      <label class="form-label"><span class="required">*</span>行きたい場所</label>
      <input type="text" name="destination" class="form-input" placeholder="" value="{{ form.destination.data or '' }}">
    </div>

    <div class="form-group">
      <label class="form-label"><span class="required">*</span>出発地点</label>
      <div class="origin-container">
        <label class="radio-card">
          <input type="radio" name="origin_type" value="current" checked>
          <span class="radio-mark"></span>
          <span class="radio-text">現在地</span>
        </label>

        <div class="origin-custom-wrapper">
          <label class="radio-card">
            <input type="radio" name="origin_type" value="custom">
            <span class="radio-mark"></span>
            <span class="radio-text">出発場所を指定する</span>
          </label>
          <input type="text" name="departure" class="form-input mt-2" placeholder="" value="{{ form.departure.data or '' }}">
        </div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">旅行の目的(複数選択可)</label>
      <div class="purpose-container">
        <input type="text" class="form-input purpose-input" data-purpose-input placeholder="観光/合宿">
        <div class="chip-list" data-purpose-list>
          <span class="chip">観光 <button type="button">&times;</button></span>
          <span class="chip">温泉 <button type="button">&times;</button></span>
        </div>
        <input type="hidden" name="purposes_raw" data-purpose-hidden value="{{ form.purposes_raw.data or '' }}">
        <button type="button" style="display:none;" data-purpose-add></button> </div>
    </div>

    <div class="form-row">
      <div class="form-group col-half">
        <label class="form-label"><span class="required">*</span>日数</label>
        <input type="number" name="days" class="form-input" placeholder="日間" value="{{ form.days.data or '' }}">
      </div>
      <div class="form-group col-half">
        <label class="form-label">出発日</label>
        <input type="date" name="start_date" class="form-input" placeholder="MM/DD" value="{{ form.start_date.data or '' }}">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">旅行に求めること</label>
      <div class="needs-grid">
        {% set needs_options = [
          "節約重視", "ちょっと贅沢", "アクティブ", "ゆったり", "グルメ",
          "ショッピング", "歴史", "自然", "穴場スポット", "定番スポット"
        ] %}
        {% for option in needs_options %}
        <label class="checkbox-card">
          <input type="checkbox" name="needs" value="{{ option }}">
          <span class="checkbox-text">{{ option }}</span>
        </label>
        {% endfor %}
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="submit-btn">旅行プランを作成する✨</button>
    </div>

  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const input = document.querySelector('[data-purpose-input]');
  const list = document.querySelector('[data-purpose-list]');
  const hidden = document.querySelector('[data-purpose-hidden]');
  
  // 初期値があればセット、なければ空
  let values = hidden.value ? hidden.value.split(',').filter(v => v) : [];
  // デモ用に空なら初期値を入れる（画像に合わせるため）
  if (values.length === 0) values = ["観光", "温泉"];

  const render = () => {
    list.innerHTML = '';
    values.forEach((val, idx) => {
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.innerHTML = `${val} <button type="button" class="chip-remove">&times;</button>`;
      chip.querySelector('.chip-remove').onclick = () => remove(idx);
      list.appendChild(chip);
    });
    hidden.value = values.join(',');
  };

  const add = () => {
    const val = input.value.trim();
    if (val && !values.includes(val)) {
      values.push(val);
      input.value = '';
      render();
    }
  };

  const remove = (index) => {
    values.splice(index, 1);
    render();
  };

  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      add();
    }
  });
  
  render();
});
</script>
{% endblock %}