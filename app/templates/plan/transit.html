{% extends "layout.html" %}
{% block title %}交通手段{% endblock %}
{% block content %}
<section class="transport-shell">
  <div class="transport-container">
    {% set active_tab = 'transit' %}
    {% include 'plan/_plan_header_tabs.html' %}

    <div class="transport-body">
      <h1>交通手段変更</h1>
      {% set flash_messages = get_flashed_messages(with_categories=true) %}
      <div class="error-inline" data-transport-error {% if not flash_messages %}hidden{% endif %}>
        {% if flash_messages %}
          {{ flash_messages[0][1] }}
        {% else %}
          選択してください
        {% endif %}
      </div>
      
      <form id="transit-form" method="POST" action="{{ url_for('plan.plan_transit') }}">
          <input type="hidden" name="transit_type" id="selected-transit-type" value="{{ selected_type or '' }}">
          
          {% set transport_options = options or [] %}
          {% if transport_options %}
            <div class="transport-options" data-transport-list>
              {% for option in transport_options %}
                {% set is_current = selected_type and option.type == selected_type %}
                {% set dimmed = selected_type and option.type != selected_type %}
                {% set classes = 'transport-card' %}
                {% if is_current %}
                  {% set classes = classes + ' selected' %}
                {% elif dimmed %}
                  {% set classes = classes + ' dimmed' %}
                {% endif %}
                <button type="button" class="{{ classes }}" data-option="{{ option.type }}">
                  <input
                    type="checkbox"
                    class="visually-hidden transport-checkbox"
                    data-option-checkbox
                    value="{{ option.type }}"
                    {% if is_current %}checked{% endif %}
                  />
                  <input
                    type="text"
                    class="visually-hidden transport-route-input"
                    value="{{ option.transport_method }}"
                    readonly
                  />
                  <div class="transport-card__header">
                    <span class="transport-title">{{ option.type }}</span>
                    <div class="transport-meta">
                      <span class="transport-price">
                        {% if option.cost %}
                          ¥{{ "{:,}".format(option.cost) }}
                        {% else %}
                          -
                        {% endif %}
                      </span>
                      <span class="transport-time">
                        {% if option.duration %}
                          移動時間{{ option.duration }}分
                        {% else %}
                          -
                        {% endif %}
                      </span>
                    </div>
                  </div>
                  
                  <div class="transport-route">
                      {{ option.transport_method }}
                      {% if option.transit_count %}
                      <div class="transport-sub">乗換: {{ option.transit_count }}回</div>
                      {% endif %}
                  </div>
                </button>
              {% endfor %}
            </div>
          {% else %}
            <p class="transport-empty">現在表示できる交通手段候補がありません。</p>
          {% endif %}

          <div class="cta-row transport-actions">
            <button type="button" class="cta-primary" data-transport-confirm>{{ button_label or '確定' }}</button>
          </div>
      </form>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const cards = document.querySelectorAll('[data-option]');
    const hiddenInput = document.getElementById('selected-transit-type');
    const checkboxes = document.querySelectorAll('[data-option-checkbox]');
    const confirmBtn = document.querySelector('[data-transport-confirm]');
    const form = document.getElementById('transit-form');
    const errorMsg = document.querySelector('[data-transport-error]');

    const applySelectionStyles = (value) => {
        cards.forEach(c => {
            const isSelected = c.dataset.option === value;
            c.classList.toggle('selected', isSelected);
            if (value) {
                c.classList.toggle('dimmed', !isSelected);
            } else {
                c.classList.remove('dimmed');
            }
        });
        checkboxes.forEach(cb => {
            cb.checked = cb.value === value;
        });
    };

    // 初期表示で選択状態を反映
    applySelectionStyles(hiddenInput.value);

    // カード選択ロジック
    cards.forEach(card => {
        card.addEventListener('click', () => {
            const value = card.dataset.option;
            hiddenInput.value = value;
            applySelectionStyles(value);
            errorMsg.hidden = true;
        });
    });

    // 確定ボタンロジック
    confirmBtn.addEventListener('click', () => {
        if (!hiddenInput.value) {
            errorMsg.hidden = false;
            return;
        }
        form.submit();
    });
});
</script>

<style>
</style>
{% endblock %}
