{% extends 'layout.html' %}

{% block title %}プラン詳細 | {{ config['BRAND_NAME'] }}{% endblock %}

{% block content %}
  <section class="page-section plan-detail" data-plan-detail data-plan-id="{{ plan.id }}">
    <article class="plan-detail-card">
      <div class="plan-detail-card__header">
        <div>
          <h1>{{ display_title }}</h1>
          <dl class="plan-detail-summary">
            <div>
              <dt>日程</dt>
              <dd>{{ plan.start_date }}～　　{{ template_days }}日間</dd>
            </div>
            <div>
              <dt>交通手段</dt>
              <dd>{{ traffic_methods | join(' / ') }}</dd>
            </div>
            <div>
              <dt>宿泊先</dt>
              <dd>{{ accommodation_label }}</dd>
            </div>
          </dl>
        </div>
        <div class="plan-detail-card__meta">
          <p>{{ meta.created_on }}</p>
          {% if is_owned %}
            <a class="save-plan-button" href="{{ url_for('plan.schedule_list') }}">スケジュール・持ち物を見る</a>
          {% else %}
            <a class="save-plan-button" href="{{ url_for('plan.plan_modals', plan_id=plan.id) }}">自分のプランとして保存する</a>
          {% endif %}
        </div>
      </div>

      <section class="plan-detail-body">
        <div class="info-columns">
          <div>
            <p class="section-label">宿泊場所</p>
            <p class="info-bold">{{ accommodation_label }}</p>
            <p>{{ meta.price }}</p>
          </div>
          <div>
            <p class="section-label">説明</p>
            <ul>
            {# short_note を全体の説明として出す #}
            {% if template_note %}
              <p class="packing-note">
                {{ template_note }}
              </p>
            {% endif %}
            </ul>
          </div>
        </div>

        {% if is_owned %}
        <section class="detail-share" data-share-box>
          <p class="section-label">共有リンク</p>
          <div class="share-url-row">
            <input type="text" readonly placeholder="リンクを発行してコピー" data-share-url-input />
            <button type="button" class="cta-button ghost" data-share-action>リンクを発行</button>
          </div>
          <p class="form-error" data-share-error hidden></p>
        </section>
        {% endif %}

        <section class="packing-section">
          <header class="packing-section__header">
            <p class="section-label">主な持ち物</p>
            <span>アイテム総数{{ meta.items_total }}</span>
          </header>



          {% if checklist_display and (checklist_display.essential or checklist_display.extra) %}
          <div class="packing-checklist">
            <div class="packing-checklist__column">
              <p class="section-label">必需品</p>
              {% if checklist_display.essential %}
              <ul class="packing-checklist__items" data-checklist-column="essential">
                {% for item in checklist_display.essential %}
                <li data-checklist-item data-checklist-item-id="{{ item.id }}">
                  <label class="packing-check">
                    <input type="checkbox" data-checklist-toggle data-checklist-item-id="{{ item.id }}" {% if item.is_checked %}checked{% endif %}>
                    <span>{{ item.name }}{% if item.quantity %}（{{ item.quantity }}{{ item.unit }}）{% endif %}</span>
                  </label>
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <p class="packing-empty">なし</p>
              {% endif %}
            </div>
            <div class="packing-checklist__column">
              <p class="section-label">補足品</p>
              {% if checklist_display.extra %}
              <ul class="packing-checklist__items" data-checklist-column="extra">
                {% for item in checklist_display.extra %}
                <li data-checklist-item data-checklist-item-id="{{ item.id }}">
                  <label class="packing-check">
                    <input type="checkbox" data-checklist-toggle data-checklist-item-id="{{ item.id }}" {% if item.is_checked %}checked{% endif %}>
                    <span>{{ item.name }}{% if item.quantity %}（{{ item.quantity }}{{ item.unit }}）{% endif %}</span>
                  </label>
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <p class="packing-empty">なし</p>
              {% endif %}
            </div>
          </div>
          {% else %}
          <table class="packing-table">
            <thead>
              <tr>
                <th>必需品</th>
                <th>補足品</th>
              </tr>
            </thead>
            <tbody>
              {% set essentials = packing_summary.essential or [] %}
              {% set extras = packing_summary.extra or [] %}
              {% set row_count = [essentials|length, extras|length] | max %}

              {% for i in range(row_count) %}
                {% set e = essentials[i] if i < essentials|length else None %}
                {% set x = extras[i] if i < extras|length else None %}

                <tr>
                  <td>
                    {% if e %}
                      {{ e.name }}（{{ e.quantity }}{{ e.unit }}）
                    {% endif %}
                  </td>

                  <td>
                    {% if x %}
                      {{ x.name }}（{{ x.quantity }}{{ x.unit }}）
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}

            </tbody>
          </table>
          {% endif %}
          <p class="form-error" data-checklist-toggle-error hidden>保存に失敗しました</p>
        </section>
      </section>

      <div class="detail-card__footer">
        <button class="cta-button ghost"
          type="button"
          data-href="{{ url_for('plan.plan_list') }}"
          onclick="window.location.href=this.dataset.href">
          戻る
        </button>
      </div>
    </article>
  </section>
  <script defer src="{{ url_for('static', filename='js/checklist_toggle.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/plan_share.js') }}"></script>
{% endblock %}
