{% extends 'layout.html' %}

{% block title %}プラン詳細 | {{ config['BRAND_NAME'] }}{% endblock %}

{% block content %}
  <section class="page-section plan-detail" data-plan-detail data-plan-id="{{ plan.id }}">
    <article class="plan-detail-card">
      <div class="plan-detail-card__header">
        <div>
          <h1>{{ plan.title }}</h1>
          <dl class="plan-detail-summary">
            <div>
              <dt>日程</dt>
              <dd>{{ plan.start_date }}　　{{ template_days }}</dd>
            </div>
            <div>
              <dt>交通手段</dt>
              <dd>{{ traffic_methods | join(' / ') }}</dd>
            </div>
            <div>
              <dt>宿泊先</dt>
              <dd>{{ accommodation_label }}</dd>
            </div>
          </dl>
        </div>
        <div class="plan-detail-card__meta">
          <p>{{ meta.created_on }}</p>
          {% if is_owned %}
            <a class="save-plan-button" href="{{ url_for('plan.plan_edit', plan_id=plan.id) }}">プランを編集</a>
          {% else %}
            <a class="save-plan-button" href="{{ url_for('plan.plan_modals') }}">自分のプランとして保存する</a>
          {% endif %}
        </div>
      </div>

      <section class="plan-detail-body">
        <div class="info-columns">
          <div>
            <p class="section-label">宿泊場所</p>
            <p class="info-bold">{{ accommodation_label }}</p>
            <p>{{ meta.price }}</p>
          </div>
          <div>
            <p class="section-label">主な滞在場所</p>
            <ul>
              {% for place in stay_locations %}
                <li>{{ place }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <section class="packing-section">
          <header class="packing-section__header">
            <p class="section-label">主な持ち物</p>
            <span>アイテム総数{{ meta.items_total }}</span>
          </header>

          {# short_note を全体の説明として出す #}
          {% if template_note %}
            <p class="packing-note">
              {{ template_note }}
            </p>
          {% endif %}
          <table class="packing-table">
            <thead>
              <tr>
                <th>必需品</th>
                <th>補足品</th>
                <th>説明</th>
              </tr>
            </thead>
            <tbody>
              {# JSON から配列を取り出す #}
              {% set essentials = packing_details.essential or [] %}
              {% set extras = packing_details.extra or [] %}
              {# 行数は essential / extra の長い方に合わせる #}
              {% set row_count = [essentials|length, extras|length]|max %}

              {% for i in range(row_count) %}
                {% set e = essentials[i] if i < essentials|length else None %}
                {% set x = extras[i] if i < extras|length else None %}
                <tr>
                  <td>
                    {% if e %}
                      {{ e.name }}（{{ e.quantity }}{{ e.unit }}）
                    {% endif %}
                  </td>
                  <td>
                    {% if x %}
                      {{ x.name }}（{{ x.quantity }}{{ x.unit }}）
                    {% endif %}
                  </td>
                  <td>
                    {# 説明は今の checklist_summary_json には入っていないので、
                      将来的に ChecklistItem から埋めたいならここで差し込む #}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </section>
      </section>

      <div class="detail-card__footer">
        <button class="cta-button ghost"
          type="button"
          data-href="{{ url_for('plan.plan_list') }}"
          onclick="window.location.href=this.dataset.href">
          戻る
        </button>
      </div>
    </article>
  </section>
{% endblock %}
